<div class="container">
    <div class="row mt-5">
        <div class="col-sm-5 dogPhotos"></div>
        <div class="col-sm-7 dogInfo">
            <div class="ml-5">
                <h1 id="dogName"></h1>
                <table class="mt-4">
                    <tbody>
                        <tr>
                            <td>Breed</td>
                            <td id="dogBreed"></td>
                        </tr>
                        <tr>
                            <td>Sex</td>
                            <td id="dogSex"></td>
                        </tr>
                        <tr>
                            <td>Age</td>
                            <td id="dogAge"></td>
                        </tr>
                        <tr>
                            <td>Size</td>
                            <td id="dogSize"></td>
                        </tr>
                        <tr>
                            <td>Rating</td>
                            <td id="dogReview">
                                <i class="fa fa-star checkmark" aria-hidden="true"></i>
                                <i class="fa fa-star checkmark" aria-hidden="true"></i>
                                <i class="fa fa-star checkmark" aria-hidden="true"></i>
                                <i class="fa fa-star checkmark" aria-hidden="true"></i>
                                <i class="fa fa-star checkmark" aria-hidden="true"></i>
                            </td>
                        </tr>
                        <tr>
                            <td>Owner</td>
                            <td id="dogOwner">
                                <span></span>
                                <a>
                                    <img alt="owner picture">
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="contact-owner mt-4">
                    <h5></h5>
                    <i class="fa fa-pencil fa-2x" data-toggle="modal" data-target="#formDogModal" aria-hidden="true"></i>
                    <i class="fa fa-trash fa-2x" data-toggle="modal" data-target="#removeDogModal" aria-hidden="true"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <h3>Description</h3>
        <p id="dogDescription"></p>
    </div>
    <div class="mt-5">
        <h3>Reviews</h3>
        <p id="dogReviews"></p>
        <div id="reviewCarousel" class="carousel slide" data-interval="false" data-wrap="false">
            <div class="carousel-inner">
            </div>
        </div>
        <form id="postReview">
            <h5>Post a review</h5>
            <div class="dog_rating">
                <button>
                    <input type="radio" name="star" value="1">
                    <i class="fa fa-star checkmark" aria-hidden="true"></i>
                </button>
                <button>
                    <input type="radio" name="star" value="2">
                    <i class="fa fa-star checkmark" aria-hidden="true"></i>
                </button>
                <button>
                    <input type="radio" checked="checked" name="star" value="3">
                    <i class="fa fa-star checkmark" aria-hidden="true"></i>
                </button>
                <button>
                    <input type="radio" name="star" value="4">
                    <i class="fa fa-star checkmark" aria-hidden="true"></i>
                </button>
                <button>
                    <input type="radio" name="star" value="5">
                    <i class="fa fa-star checkmark" aria-hidden="true"></i>
                </button>
            </div>
            <textarea class="form-control" name="dog_review" rows="3"></textarea>
            <input type="submit" value="Submit" class="btn btn-primary mt-3">
        </form>
    </div>
</div>

<div class="modal fade" id="removeDogModal" tabindex="-1" role="dialog" aria-labelledby="removeDogModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeDogModalLabel">Remove dog</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure to remove this dog from Pawww?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-button">Yes</button>
            </div>
        </div>
    </div>
</div>

{{> form}}

<script>
    $(function () {

        // Make dog carousel
        function renderDogCarousel(dogJson) {
            let imgs = dogJson.photos.map((img, i) => {
                if (i == 0) {
                    return `<div class="carousel-item active">
                        <img src="data:image ;base64, ${img}" alt="dog image" />
                    </div>`

                } else {
                    return `<div class="carousel-item">
                        <img src="data:image ;base64, ${img}" alt="dog image" />
                    </div>`
                }
            })

            let thumbnail = dogJson.photos.map((img, i) => {
                if (i == 0) {
                    return `<button data-target="#${dogJson._id}" data-slide-to="0" class="active thumbnail"><img src="data:image ;base64, ${img}" alt="dog image"/></button>`
                } else {
                    return `<button data-target="#${dogJson._id}" class="thumbnail" data-slide-to="${i}" ><img src="data:image ;base64, ${img}" alt="dog image" /></button>`
                }
            })

            let s = `<div id="${dogJson._id}" class="carousel slide">
                                <div class="carousel-inner">
                                    ${imgs.join("")}
                                </div>
                                </div>
                                <div class="mt-3 d-flex justify-content-center">
                                    ${thumbnail.join("")}
                                </div>
                            </div>`
            return s
        }

        // Get dog information
        $.get("/dog" + window.location.pathname).done(dogJson => {
            $('.dogPhotos').html(renderDogCarousel(dogJson));
            $('#dogName').html(dogJson.name);
            $('#dogBreed').html(dogJson.breed);
            $('#dogSex').html(dogJson.sex);
            $('#dogAge').html(dogJson.age);
            $('#dogSize').html(dogJson.size);
            $('#dogOwner span').html(dogJson.ownerName);
            $('#dogOwner img').attr({ src: dogJson.ownerPhoto[0] });
            $('#dogOwner a').attr({
                href: "/user/" + dogJson.ownerID,
                target: "_blank"
            });
            $('#dogDescription').html(dogJson.description.replace(/\n/g, '<br>'));
        })

        // Change star color on click
        const starColor = (num) => {
            $('.dog_rating button:nth-child(' + num + ')').click(() => {
                for (let x = 1; x <= num; x++) {
                    $('.dog_rating button:nth-child(' + x + ')').css({
                        color: 'rgb(232, 232, 0)'
                    })
                }
                for (let y = num + 1; y <= 5; y++) {
                    $('.dog_rating button:nth-child(' + y + ')').css({
                        color: 'inherit'
                    })
                }
            });
        };

        starColor(1);
        starColor(2);
        starColor(3);
        starColor(4);
        starColor(5);

        // Default star rating at 3
        for (let x = 1; x <= 3; x++) {
            $('.dog_rating button:nth-child(' + x + ')').css({
                color: 'rgb(232, 232, 0)'
            })
        }
        for (let y = 4; y <= 5; y++) {
            $('.dog_rating button:nth-child(' + y + ')').css({
                color: 'inherit'
            })
        }

        // Get review
        $.get('/review' + window.location.pathname).done(reviews => {
            console.log(reviews);
            for (let table = 0; table <= Math.floor(reviews.length/3); table++) {
                $('#reviewCarousel .carousel-inner').append(`
                    <div class="carousel-item">
                        <table class="review-table mt-3">
                            <tbody></tbody>
                        </table>
                    </div>
                `);
            };
            $('#reviewCarousel .carousel-item:first-child').addClass('active');
            for (let review = 0; review <= reviews.length; review++) {
                let tableNum = Math.ceil(review/3);
                $('#reviewCarousel .carousel-item:nth-child('+ tableNum + ')').append(`
                `);
            };
        });

        // Post review
        $('#postReview').submit(event => {
            event.preventDefault();
            $.post('/review' + window.location.pathname, {
                rating: $('#postReview input[name="star"]:checked').val(),
                text: $('#postReview textarea').val()
            }).done(reviews => {
                console.log(reviews)
            })
        });
    }) 
</script>

<script src="/js/updateDog.js"></script>